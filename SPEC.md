# LongPort AI 助手技术规格说明书

## 目录

1. [产品概述](#1-产品概述)
   - [1.1 产品定位](#11-产品定位)
   - [1.2 用户故事](#12-用户故事)
   - [1.3 非目标](#13-非目标)
2. [功能规格](#2-功能规格)
   - [2.1 功能实现范围](#21-功能实现范围)
   - [2.2 核心功能流程](#22-核心功能流程)
   - [2.3 用户界面组件](#23-用户界面组件)
3. [技术规格](#3-技术规格)
   - [3.1 权限申请与说明](#31-权限申请与说明)
   - [3.2 数据存储与传输](#32-数据存储与传输)
   - [3.3 API 接口规范](#33-api-接口规范)
4. [实现细节](#4-实现细节)
   - [4.1 弹窗实现机制](#41-弹窗实现机制)
   - [4.2 优化记录管理](#42-优化记录管理)
   - [4.3 文案优化测试模块](#43-文案优化测试模块)
5. [风险与审核](#5-风险与审核)
   - [5.1 潜在风险](#51-潜在风险)
   - [5.2 Chrome Web Store 审核要点](#52-chrome-web-store-审核要点)
6. [演示脚本](#6-演示脚本)
   - [6.1 五分钟演示脚本](#61-五分钟演示脚本)

---

## 1. 产品概述

### 1.1 产品定位

LongPort AI 助手是一个浏览器扩展程序，专为 Notion、LongPort 文档平台提供 AI 辅助写作和文本优化功能，旨在提升用户的文档编写效率和内容质量。

### 1.2 用户故事

- **Notion/LongPort 用户**：在编辑器中选中文本，快速触发 AI 优化，提高专业性和清晰度
- **内容创作者**：获得语法检查和语言优化，确保表达准确
- **企业文档人员**：基于企业文案规范进行统一化优化

### 1.3 非目标

- 不支持离线模式
- 不支持全文档扫描
- 不提供实时协作编辑
- 不作为独立编辑器
- 不提供文档版本管理

---

## 2. 功能规格

### 2.1 功能实现范围

#### 2.1.1 必须实现

- **文本优化（基础模式）**
    - 文本选中 → 优化 → 弹窗结果 → 替换/取消
- **触发方式**
    - 快捷键（默认 Alt+O）
    - 右键菜单
- **弹窗**
    - 可拖拽（长按弹窗标题区域支持拖拽）
    - 显示优化结果与字数变化
    - 替换/取消/关闭按钮
    - 加载状态提示
    - 智能定位：
      - 默认显示在选中文本下方
      - 当下方空间不足时，自动显示在选中文本上方
      - 当上下方都空间不足时，在浏览器视窗中央显示
- **设置界面**
    - API 配置
      - API 地址输入（支持公司/个人 API）
      - API 密钥输入（支持明文/隐藏切换）
      - API 连接测试功能（显示连接状态和响应时间）
    - 快捷键配置
      - 支持自定义快捷键组合
      - 提供快捷键冲突检测
      - 实时预览
    - 文案优化效果测试
      - 文本输入框
      - 优化模式选择（基础/严格）
      - 执行按钮
      - 结果展示区（优化前后对比、字数统计、处理时间）
      - 复制/清空功能
- **API 调用机制**
    - RESTful 调用
    - 错误重试 + 超时处理
- **安全性**
    - API 密钥本地加密
    - HTTPS 传输
- **优化记录管理**
    - 侧边栏面板（与浏览器高度一致）
    - 优化记录列表
    - 记录详情查看
    - 复制/删除功能

#### 2.1.2 可选实现

- 严格模式优化（规范标注）
- 界面偏好（主题/字号等）
- 优化进度展示
- 支持更多平台

### 2.2 核心功能流程

#### 2.2.1 基础文本优化流程

**流程步骤**：
1. 用户在编辑器中选中文本
2. 用户通过快捷键 **Alt+O** 或右键菜单触发优化
3. 系统调用 API，进入加载状态
4. 弹窗显示优化结果 + 字数变化
   - 弹窗智能定位：默认显示在选中文本下方
   - 当下方空间不足时，自动显示在选中文本上方
   - 当上下方都空间不足时，在浏览器视窗中央显示
   - 用户可通过长按弹窗标题区域拖拽到任意位置
5. 用户点击：
    - **替换** → 原文替换为优化结果
    - **取消** → 关闭弹窗

**实现机制**：
- 将用户选中的原始文本发送至 API 对接的 AI 模型
- AI 模型执行多维度优化：
  - **语法校正**：修正错误的语法结构
  - **标点规范**：统一标点符号使用
  - **中英混排规则**：优化中英文混合排版
  - **语言风格**：采用专业、清晰、友好的表达方式
  - **语调控制**：保持克制，避免过度营销和夸张表达
- 优化原则：
  - 保持与原文语义一致
  - 字数相当（不大幅增减）
  - 提升表达清晰度和专业性
- 返回优化后的文本及字数变化统计

#### 2.2.2 严格模式优化流程

**流程步骤**：
1. 用户在设置中启用严格模式，并配置文案指引
2. 用户触发优化功能
3. 系统基于「基础优化 + 文案规范」生成结果
4. 弹窗展示优化文本，并标注遵循的规范要点
5. 用户点击替换，文本更新

**实现机制**：
- 首先执行基础文本优化流程
- 将用户配置的文案指引规范作为附加条件提供给 AI
- AI 执行双重验证：
  - 第一轮：基础语言优化（同基础模式）
  - 第二轮：根据文案指引规范进行调整和验证
- 优化结果会标注遵循了哪些具体规范要点
- 确保输出文本同时符合语言规范和企业文案标准
- 返回优化后的文本、字数变化及规范符合度

#### 2.2.3 优化记录管理流程

**流程步骤**：
1. 用户点击 Chrome 浏览器工具栏中的扩展图标
2. 系统唤起侧边栏面板
   - 侧边栏高度与浏览器视窗高度一致
   - 显示历史优化记录列表
3. 用户可查看优化记录列表
   - 每条记录显示优化日期、时间
   - 显示优化文本的摘要（前几个字）
   - 显示优化来源（网站名称）
   - 显示优化模式（基础/严格）
4. 用户点击列表中的记录项
5. 系统展开显示记录详情
   - 显示原始文本
   - 显示优化后文本
   - 显示优化统计信息（字数变化等）
   - 提供复制原文/优化文本的功能
6. 用户可删除单条记录或清空所有记录

### 2.3 用户界面组件

#### 2.3.1 设置界面

**API 配置与测试**：
1. 用户进入插件设置界面
2. 输入 API 地址和密钥
   - 支持输入公司 API 地址
   - 支持输入个人 API 密钥
   - 提供明文/隐藏切换选项
3. 用户点击「测试连接」按钮
   - 系统发送测试请求验证 API 连通性
   - 显示测试结果（成功/失败）及响应时间
   - 失败时显示错误原因
4. 系统验证通过后，本地加密存储 API 信息

**快捷键配置**：
1. 用户在设置界面进入快捷键配置模块
2. 系统显示当前配置的快捷键
   - 润色一下：默认 Alt+O
   - 替换：默认 空格
3. 用户可修改快捷键组合
   - 支持键盘按键录入
   - 提供快捷键冲突检测
4. 用户保存设置，系统立即应用新快捷键

**文案优化效果测试**：
1. 用户在设置界面进入文案优化效果测试模块
2. 系统显示独立的测试界面
   - 文本输入框：用于输入待优化的文本
   - 优化模式选择：基础模式/严格模式
   - 执行按钮：触发优化测试
3. 用户输入测试文本并选择优化模式
4. 用户点击「执行优化」按钮
   - 系统显示加载状态
   - 系统调用 API 进行文本优化
5. 系统在结果区域显示优化后的文本
   - 显示优化前后对比
   - 显示字数变化统计
   - 显示处理时间
6. 用户可以复制优化结果或清空重新测试

---

## 3. 技术规格

### 3.1 权限申请与说明

#### 3.1.1 Manifest 权限

- **storage**：存储用户配置和密钥（加密）
- **contextMenus**：右键菜单调用
- **activeTab**：访问当前页面文本
- **scripting**：注入脚本修改 DOM

#### 3.1.2 Host Permissions

- `://*.notion.so/*`
- `://*.longport.com/*`
- `https://api.company.com/*`

#### 3.1.3 权限原则

遵循**最小权限原则**，不涉及 cookies/历史记录。

### 3.2 数据存储与传输

#### 3.2.1 本地存储

| **字段** | **类型** | **描述** |
| --- | --- | --- |
| apiKey | string(加密) | API 密钥 |
| apiUrl | string | API 地址 |
| strictMode | boolean | 严格模式开关 |
| guideScenarios | object | 文案规范配置 |
| shortcuts | object | 快捷键设置 |
| uiPreferences | object | UI 偏好 |
| lastUsed | timestamp | 最后使用时间 |
| optimizationRecords | array | 优化记录数组 |

#### 3.2.2 优化记录结构

| **字段** | **类型** | **描述** |
| --- | --- | --- |
| id | string | 记录唯一标识 |
| timestamp | number | 优化时间戳 |
| sourceUrl | string | 来源网页URL |
| sourceDomain | string | 来源网站域名 |
| originalText | string | 原始文本 |
| optimizedText | string | 优化后文本 |
| mode | string | 优化模式（基础/严格） |
| stats | object | 统计信息（字数变化等） |

#### 3.2.3 API 数据交互

- **发送**：原始文本、场景标识
- **接收**：优化文本、字数变化统计
- **生命周期**：仅在弹窗会话期间存在，不做持久存储

### 3.3 API 接口规范

#### 3.3.1 基础优化接口

**请求要求**：
- 请求方式：POST
- 接口路径：/api/optimize/text
- 内容类型：application/json
- 认证方式：Bearer Token 认证，在 Authorization 头部传递 API 密钥

**请求参数**：
- text：需要优化的原始文本（必填）
- mode：优化模式，设置为 "basic"（必填）
- options：可选配置参数
  - maxLength：文本最大长度限制，默认 2000
  - preserveFormat：是否保留原文格式，默认 true

**响应内容**：
- success：操作是否成功（布尔值）
- data：返回数据对象
  - optimizedText：优化后的文本内容
  - stats：统计信息
    - originalLength：原文字数
    - optimizedLength：优化后字数
    - changeRatio：变化比例（正值表示增加，负值表示减少）
    - processingTime：处理时间（秒）

#### 3.3.2 严格模式接口

**请求要求**：
- 与基础优化接口相同，但 mode 参数设置为 "strict"
- 增加 guideScenarios 参数：指定应用的文案规范场景数组，如 ["corporate", "formal"]

**响应内容**：
- 包含基础优化接口的所有返回内容
- 额外返回 guidelines 数组，包含每个规范的符合情况
  - name：规范名称
  - compliance：符合度（0-1之间的小数）
  - details：具体符合的规范点列表

#### 3.3.3 API 连接测试接口

**请求要求**：
- 请求方式：GET
- 接口路径：/api/status
- 认证方式：Bearer Token 认证

**响应内容**：
- success：操作是否成功
- data：服务状态信息
  - status：服务状态（operational/degraded/maintenance）
  - version：API 版本
  - requestLimit：API 调用限制
  - requestsRemaining：剩余可用请求数
  - responseTime：响应时间（秒）

#### 3.3.4 错误处理

**错误响应格式**：
- success：false
- error：错误信息对象
  - code：错误代码
  - message：错误描述信息
  - details：详细错误信息（可选）

**常见错误代码**：
- AUTH_FAILED：API 密钥无效或已过期
- RATE_LIMIT_EXCEEDED：超出 API 调用频率限制
- TEXT_TOO_LONG：文本长度超出限制
- INVALID_MODE：无效的优化模式
- SERVER_ERROR：服务器内部错误

---

## 4. 实现细节

### 4.1 弹窗实现机制

#### 4.1.1 弹窗组件结构

弹窗组件采用Shadow DOM实现，确保样式不受页面影响，主要结构包括：

- **弹窗容器**：包含定位属性和整体样式
- **标题栏**：包含标题文本和关闭按钮，同时作为拖拽触发区域
- **内容区域**：包含两种状态视图
  - 加载状态：显示加载动画和提示文本
  - 结果状态：显示优化后文本和统计信息
- **底部操作栏**：包含替换和取消按钮
- **样式隔离**：使用Shadow DOM确保弹窗样式不受页面样式影响
- **CSS命名规范**：所有类名添加"lp-ai-"前缀，避免样式冲突

#### 4.1.2 弹窗定位算法

弹窗智能定位采用以下算法：

1. **获取选中文本位置**：
   - 通过浏览器Selection API获取选中文本的范围对象
   - 使用getBoundingClientRect()方法获取选中区域的位置和尺寸

2. **计算可用空间**：
   - 获取浏览器视窗高度
   - 计算选中文本下方可用空间（视窗高度减去选中区域底部位置）
   - 计算选中文本上方可用空间（选中区域顶部位置）

3. **决定弹窗位置**：
   - 设定弹窗高度（固定值或动态计算）
   - 如果下方空间足够，弹窗显示在选中文本下方（默认位置）
   - 如果下方空间不足但上方空间足够，弹窗显示在选中文本上方
   - 如果上下方空间都不足，弹窗在浏览器视窗中央显示

4. **设置弹窗位置**：
   - 根据决定的位置，设置弹窗的top、left等CSS属性
   - 记录当前定位方式，用于后续可能的位置调整

#### 4.1.3 弹窗拖拽实现

弹窗拖拽功能实现机制：

- **触发方式**：长按弹窗标题区域超过200毫秒触发拖拽
- **拖拽状态管理**：
  - 记录拖拽状态（是否正在拖拽）
  - 记录鼠标在弹窗内的相对位置（offsetX, offsetY）
  - 添加拖拽状态的视觉反馈（如添加特定CSS类）
- **拖拽过程**：
  - 监听鼠标移动事件，计算新位置
  - 实时更新弹窗位置（top, left属性）
  - 移除原有的定位数据属性，切换到自由定位模式
- **拖拽结束**：
  - 监听鼠标释放事件
  - 清除拖拽状态和视觉反馈
  - 保持弹窗在最后拖拽位置

#### 4.1.4 弹窗状态管理

弹窗具有以下几种状态：

1. **加载状态**：
   - 显示加载动画（旋转图标）
   - 显示"正在优化文本..."提示
   - 隐藏结果区域

2. **结果状态**：
   - 隐藏加载动画
   - 显示优化后的文本内容
   - 显示统计信息：
     - 字数变化（原始字数→优化后字数，增减百分比）
     - 处理时间（秒）
   - 严格模式下显示规范符合信息：
     - 规范名称和符合度百分比
     - 符合的具体规范点列表

3. **错误状态**：
   - 隐藏加载动画
   - 显示错误信息
   - 提供重试按钮
   - 错误信息包含具体错误原因

### 4.2 优化记录管理

#### 4.2.1 功能概述

- 记录并管理用户的文本优化历史
- 通过侧边栏形式展示，便于查看和复用历史优化内容
- 提供详细的优化前后对比，帮助用户追踪文案改进

#### 4.2.2 侧边栏界面

- **触发方式**：点击 Chrome 浏览器工具栏中的扩展图标
- **界面布局**：
  - 侧边栏面板，高度与浏览器视窗一致
  - 顶部：标题栏和功能按钮（刷新、清空、设置等）
  - 中部：优化记录列表
  - 底部：状态信息（记录总数等）

#### 4.2.3 记录列表功能

- **列表项展示**：
  - 优化日期和时间
  - 文本摘要（前20个字符）
  - 来源网站图标和名称
  - 优化模式标签（基础/严格）
- **交互功能**：
  - 点击记录项展开详情
  - 长按记录项显示操作菜单（复制、删除）
  - 支持按日期、来源筛选记录
  - 支持搜索记录内容

#### 4.2.4 记录详情功能

- **详情视图**：
  - 原始文本与优化后文本对比展示
  - 优化统计信息（字数变化、优化时间等）
  - 来源页面链接
- **操作功能**：
  - 复制原始文本
  - 复制优化后文本
  - 删除当前记录
  - 返回列表视图

#### 4.2.5 数据管理

- 本地存储记录（使用 chrome.storage.local）
- 提供记录导出功能（JSON 格式）
- 支持记录自动清理（可配置保留时间）
- 提供手动清空所有记录功能

### 4.3 文案优化测试模块

#### 4.3.1 测试功能概述

- 设置页面中的独立文案优化测试模块，用于验证 API 功能和优化效果
- 不依赖于特定网页环境，可在扩展设置内直接使用
- 提供即时反馈，帮助用户了解优化效果和调整配置

#### 4.3.2 测试界面

- **输入区域**：用于输入待测试的原始文本
- **参数配置**：
  - 优化模式选择（基础/严格）
  - 严格模式下可选择应用的文案规范
- **操作按钮**：
  - 执行优化
  - 复制结果
  - 清空内容
- **结果展示区**：
  - 优化前后文本对比
  - 优化统计（字数变化、处理时间等）
  - 严格模式下显示规范符合度

#### 4.3.3 测试流程

1. 用户在设置页面进入文案优化效果测试模块
2. 输入或粘贴待优化文本
3. 选择优化模式（基础/严格）
4. 点击「执行优化」按钮
5. 系统调用 API，展示加载状态
6. 显示优化前后对比、字数变化统计和处理时间
7. 用户可复制优化结果或清空重新测试

---

## 5. 风险与审核

### 5.1 潜在风险

- **API 依赖**：需错误重试和错误提示
- **网站兼容性**：Notion/LongPort 更新可能破坏注入脚本 → 定期测试
- **Chrome 审核风险**：需严格说明权限用途
- **密钥安全**：采用本地加密存储

### 5.2 Chrome Web Store 审核要点

- 权限使用合理性说明
- 数据安全与隐私保护措施
- 代码安全性（避免危险函数）
- 功能描述准确性
- 用户体验与界面友好性

---

## 6. 演示脚本

### 6.1 五分钟演示脚本

1. **安装与配置**（30s）
    - 打开扩展 → 进入设置界面
    - 输入 API 地址和密钥
    - 演示 API 连接测试功能
    - 配置快捷键 → 保存

2. **基础优化演示**（45s）
    - 在 Notion 输入一段错误文本
    - Alt+O → 弹窗智能定位 → 展示拖拽功能 → 替换

3. **右键菜单演示**（30s）
    - LongPort 页面 → 选中文本 → 右键 → 优化
    - 展示弹窗智能定位（选中文本下方/上方/居中）
    - 展示拖拽功能 → 替换

4. **严格模式演示**（30s）
    - 设置 → 启用严格模式 → 优化 → 展示规范标注

5. **优化记录管理演示**（45s）
    - 点击浏览器工具栏扩展图标
    - 展示侧边栏面板（与浏览器等高）
    - 显示优化记录列表
    - 点击记录查看详情（原文/优化后文本对比）
    - 演示复制功能
    - 演示记录删除功能

6. **设置页面文案优化效果测试**（30s）
    - 进入扩展设置 → 文案优化效果测试模块
    - 输入示例文本
    - 选择优化模式（基础模式）
    - 点击「执行优化」按钮
    - 展示优化前后对比、字数统计

7. **结束语**（30s）
    - 强调提升效率 & 专业性
    - 突出记录管理和测试模块的便捷性