<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options AI测试模块修复验证</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .test-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .test-container h2 {
            color: #333;
            margin-top: 0;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .result-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        
        .result-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        
        .result-item .label {
            font-weight: bold;
            min-width: 120px;
            margin-right: 20px;
            color: #333;
        }
        
        .result-item .content {
            flex: 1;
            white-space: pre-wrap;
            line-height: 1.6;
        }
        
        .test-status {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            display: none;
            text-align: center;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-text h4 {
            margin: 0 0 10px 0;
            color: #1976d2;
        }
        
        .status-text p {
            margin: 0;
            color: #666;
        }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e1e5e9;
        }
        
        .metric-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .metric-card .label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .error-section {
            background: #fef2f2;
            border-left: 4px solid #dc2626;
            padding: 15px;
            margin-top: 20px;
            border-radius: 0 8px 8px 0;
            display: none;
        }
        
        .error-section h4 {
            margin-top: 0;
            color: #dc2626;
        }
        
        .success-section {
            background: #f0fdf4;
            border-left: 4px solid #16a34a;
            padding: 15px;
            margin-top: 20px;
            border-radius: 0 8px 8px 0;
            display: none;
        }
        
        .success-section h4 {
            margin-top: 0;
            color: #16a34a;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🔧 Options AI测试模块修复验证</h1>
        <p>验证AI文案优化测试模块的修复效果</p>
    </div>
    
    <div class="test-container">
        <h2>🧪 AI文案优化测试</h2>
        
        <div class="form-group">
            <label for="testInputText">测试文案：</label>
            <textarea 
                id="testInputText" 
                placeholder="请输入需要优化的文案内容..."
                rows="6"
            >这是一个关于投资理财的文案，我们需要优化它的表达方式，使其更加专业和清晰。投资有风险，收益不确定，请谨慎决策。</textarea>
        </div>
        
        <div class="form-group">
            <label for="testSiteType">测试场景：</label>
            <select id="testSiteType">
                <option value="longport">LongPort 金融平台</option>
                <option value="notion">Notion 文档协作</option>
                <option value="general">通用文本</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="testOptimizationType">优化类型：</label>
            <select id="testOptimizationType">
                <option value="deep_optimization">深度优化</option>
                <option value="grammar_check">语法检查</option>
                <option value="style_improvement">风格改进</option>
            </select>
        </div>
        
        <button type="button" id="startTest" class="btn">
            🚀 开始AI优化测试
        </button>
        
        <button type="button" id="clearTest" class="btn btn-secondary">
            🗑️ 清空内容
        </button>
        
        <button type="button" id="loadSampleText" class="btn btn-secondary">
            📋 加载示例文案
        </button>
    </div>
    
    <!-- 测试状态 -->
    <div id="testStatus" class="test-status">
        <div class="loading-spinner"></div>
        <div class="status-text">
            <h4>AI 正在优化您的文案...</h4>
            <p id="statusMessage">请稍候，这可能需要几秒钟时间</p>
        </div>
    </div>
    
    <!-- 测试结果 -->
    <div id="resultSection" class="result-section">
        <h3>✨ AI优化结果</h3>
        
        <div class="result-item">
            <div class="label">原始文案：</div>
            <div class="content" id="originalText"></div>
        </div>
        
        <div class="result-item">
            <div class="label">AI优化后：</div>
            <div class="content" id="optimizedText"></div>
        </div>
        
        <div class="metrics">
            <div class="metric-card">
                <div class="value" id="lengthChange">0%</div>
                <div class="label">长度变化</div>
            </div>
            <div class="metric-card">
                <div class="value" id="processingTime">0ms</div>
                <div class="label">处理时间</div>
            </div>
            <div class="metric-card">
                <div class="value" id="testStatus">-</div>
                <div class="label">测试状态</div>
            </div>
        </div>
    </div>
    
    <!-- 成功提示 -->
    <div id="successSection" class="success-section">
        <h4>✅ 测试成功！</h4>
        <p>AI文案优化测试模块已修复，能够正确返回优化结果。</p>
    </div>
    
    <!-- 错误提示 -->
    <div id="errorSection" class="error-section">
        <h4>❌ 测试失败</h4>
        <p id="errorMessage">测试过程中出现错误，请检查控制台日志。</p>
    </div>
    
    <script>
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Options AI测试模块修复验证页面加载完成');
            bindEvents();
        });
        
        // 绑定事件
        function bindEvents() {
            const startTestBtn = document.getElementById('startTest');
            const clearTestBtn = document.getElementById('clearTest');
            const loadSampleTextBtn = document.getElementById('loadSampleText');
            
            if (startTestBtn) {
                startTestBtn.addEventListener('click', startAITest);
                console.log('✅ 绑定开始测试按钮');
            }
            
            if (clearTestBtn) {
                clearTestBtn.addEventListener('click', clearTestContent);
                console.log('✅ 绑定清空内容按钮');
            }
            
            if (loadSampleTextBtn) {
                loadSampleTextBtn.addEventListener('click', loadSampleText);
                console.log('✅ 绑定加载示例文案按钮');
            }
            
            console.log('事件绑定完成');
        }
        
        // 开始AI测试
        async function startAITest() {
            console.log('🚀 开始AI文案优化测试...');
            
            const inputText = document.getElementById('testInputText')?.value?.trim();
            const siteType = document.getElementById('testSiteType')?.value || 'general';
            const optimizationType = document.getElementById('testOptimizationType')?.value || 'deep_optimization';
            
            if (!inputText) {
                alert('请输入需要优化的文案内容');
                return;
            }
            
            if (inputText.length < 10) {
                alert('文案内容太短，建议输入至少10个字符');
                return;
            }
            
            if (inputText.length > 1000) {
                alert('文案内容太长，建议不超过1000个字符');
                return;
            }
            
            // 显示测试状态
            showTestStatus();
            
            // 记录开始时间
            const startTime = Date.now();
            
            try {
                // 调用AI进行优化
                const response = await chrome.runtime.sendMessage({
                    action: 'callAI',
                    text: inputText,
                    apiType: 'company',
                    siteType: siteType,
                    optimizationType: optimizationType
                });
                
                // 计算处理时间
                const processingTime = Date.now() - startTime;
                
                console.log('AI响应:', response);
                
                if (response && response.success) {
                    // 安全地获取优化后的文本 - 支持多种可能的字段名
                    let optimizedText = '';
                    
                    // 按优先级尝试不同的字段
                    if (response.optimizedText && typeof response.optimizedText === 'string' && response.optimizedText.trim().length > 0) {
                        optimizedText = response.optimizedText;
                    } else if (response.result && typeof response.result === 'string' && response.result.trim().length > 0) {
                        optimizedText = response.result;
                    } else if (response.text && typeof response.text === 'string' && response.text.trim().length > 0) {
                        optimizedText = response.text;
                    } else if (response.optimized_text && typeof response.optimized_text === 'string' && response.optimized_text.trim().length > 0) {
                        optimizedText = response.optimized_text;
                    } else if (response.data && typeof response.data === 'string' && response.data.trim().length > 0) {
                        optimizedText = response.data;
                    }
                    
                    // 检查是否成功获取到优化文本
                    if (optimizedText && optimizedText.trim().length > 0) {
                        // 显示优化结果
                        showTestResult(inputText, optimizedText, processingTime);
                        showSuccessSection();
                    } else {
                        // 优化结果为空或无效
                        console.error('❌ AI返回的优化结果为空或格式无效:', response);
                        showTestError(inputText, 'AI返回的优化结果为空或格式无效，请修复，比生效线上插件', processingTime);
                        showErrorSection('AI返回的优化结果为空或格式无效');
                    }
                } else {
                    // 显示错误结果
                    const errorMessage = response?.error || response?.message || 'AI优化失败';
                    showTestError(inputText, errorMessage, processingTime);
                    showErrorSection(errorMessage);
                }
                
            } catch (error) {
                console.error('❌ AI测试失败:', error);
                const processingTime = Date.now() - startTime;
                showTestError(inputText, `测试失败: ${error.message}`, processingTime);
                showErrorSection(`测试失败: ${error.message}`);
            }
        }
        
        // 显示测试状态
        function showTestStatus() {
            const testStatus = document.getElementById('testStatus');
            const resultSection = document.getElementById('resultSection');
            const successSection = document.getElementById('successSection');
            const errorSection = document.getElementById('errorSection');
            
            if (testStatus) testStatus.style.display = 'block';
            if (resultSection) resultSection.style.display = 'none';
            if (successSection) successSection.style.display = 'none';
            if (errorSection) errorSection.style.display = 'none';
        }
        
        // 显示测试结果
        function showTestResult(originalText, optimizedText, processingTime) {
            console.log('✅ 显示测试结果:', { originalText, optimizedText, processingTime });
            
            // 隐藏测试状态
            const testStatus = document.getElementById('testStatus');
            if (testStatus) testStatus.style.display = 'none';
            
            // 显示结果区域
            const resultSection = document.getElementById('resultSection');
            if (resultSection) resultSection.style.display = 'block';
            
            // 填充原始文案
            const originalTextEl = document.getElementById('originalText');
            if (originalTextEl) originalTextEl.textContent = originalText;
            
            // 填充优化后文案
            const optimizedTextEl = document.getElementById('optimizedText');
            if (optimizedTextEl) optimizedTextEl.textContent = optimizedText;
            
            // 更新指标
            const lengthChange = ((optimizedText.length - originalText.length) / originalText.length * 100).toFixed(1);
            document.getElementById('lengthChange').textContent = lengthChange + '%';
            document.getElementById('processingTime').textContent = processingTime + 'ms';
            document.getElementById('testStatus').textContent = '成功';
        }
        
        // 显示测试错误
        function showTestError(originalText, errorMessage, processingTime) {
            console.log('❌ 显示测试错误:', { originalText, errorMessage, processingTime });
            
            // 隐藏测试状态
            const testStatus = document.getElementById('testStatus');
            if (testStatus) testStatus.style.display = 'none';
            
            // 显示结果区域
            const resultSection = document.getElementById('resultSection');
            if (resultSection) resultSection.style.display = 'block';
            
            // 填充原始文案
            const originalTextEl = document.getElementById('originalText');
            if (originalTextEl) originalTextEl.textContent = originalText || '无原始文案';
            
            // 显示错误信息
            const optimizedTextEl = document.getElementById('optimizedText');
            if (optimizedTextEl) optimizedTextEl.textContent = `❌ ${errorMessage}`;
            
            // 更新指标
            document.getElementById('lengthChange').textContent = '0%';
            document.getElementById('processingTime').textContent = processingTime + 'ms';
            document.getElementById('testStatus').textContent = '失败';
        }
        
        // 显示成功提示
        function showSuccessSection() {
            const successSection = document.getElementById('successSection');
            if (successSection) successSection.style.display = 'block';
        }
        
        // 显示错误提示
        function showErrorSection(message) {
            const errorSection = document.getElementById('errorSection');
            const errorMessage = document.getElementById('errorMessage');
            if (errorSection) errorSection.style.display = 'block';
            if (errorMessage) errorMessage.textContent = message;
        }
        
        // 清空测试内容
        function clearTestContent() {
            document.getElementById('testInputText').value = '';
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('successSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none';
            document.getElementById('testStatus').style.display = 'none';
        }
        
        // 加载示例文案
        function loadSampleText() {
            const sampleTexts = [
                '这是一个关于投资理财的文案，我们需要优化它的表达方式，使其更加专业和清晰。投资有风险，收益不确定，请谨慎决策。',
                '首先我们需要分析市场情况，其次制定投资策略，最后执行投资计划。这个过程需要团队协作，确保每个步骤都得到妥善处理。',
                '我们的产品具有高质量、低价格、好服务的特点，能够满足客户的各种需求，提供优质的购物体验。'
            ];
            
            const randomIndex = Math.floor(Math.random() * sampleTexts.length);
            document.getElementById('testInputText').value = sampleTexts[randomIndex];
        }
        
        console.log('Options AI测试模块修复验证页面脚本已加载');
    </script>
</body>
</html>
