<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API连接诊断测试页面</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .diagnosis-panel {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .diagnosis-panel h2 {
            color: #333;
            margin-top: 0;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .console-output {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 20px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-running {
            background-color: #ffc107;
            animation: pulse 1.5s infinite;
        }
        
        .status-success {
            background-color: #28a745;
        }
        
        .status-error {
            background-color: #dc3545;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .result-summary {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .result-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #dee2e6;
        }
        
        .result-item.success {
            border-left-color: #28a745;
        }
        
        .result-item.warning {
            border-left-color: #ffc107;
        }
        
        .result-item.error {
            border-left-color: #dc3545;
        }
        
        .instructions {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 0 8px 8px 0;
        }
        
        .instructions h3 {
            margin-top: 0;
            color: #1976d2;
        }
        
        .instructions ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🔍 API连接诊断工具</h1>
        <p>诊断为什么API平台没有发现请求次数增加</p>
    </div>
    
    <div class="instructions">
        <h3>📋 使用说明</h3>
        <ol>
            <li><strong>点击"开始诊断"按钮</strong> - 自动执行所有诊断步骤</li>
            <li><strong>查看控制台输出</strong> - 在下方控制台区域查看详细诊断信息</li>
            <li><strong>分析诊断结果</strong> - 根据结果确定问题所在</li>
            <li><strong>查看建议</strong> - 按照建议进行相应的修复</li>
        </ol>
    </div>
    
    <div class="diagnosis-panel">
        <h2>🚀 诊断控制面板</h2>
        
        <div class="button-group">
            <button class="btn btn-primary" onclick="startDiagnosis()">
                🔍 开始诊断
            </button>
            <button class="btn btn-secondary" onclick="clearConsole()">
                🗑️ 清空控制台
            </button>
            <button class="btn btn-success" onclick="exportResults()">
                📥 导出结果
            </button>
            <button class="btn btn-warning" onclick="showInstructions()">
                📖 详细说明
            </button>
        </div>
        
        <div id="status-display">
            <p><span class="status-indicator status-success"></span>准备就绪，点击"开始诊断"按钮开始</p>
        </div>
        
        <div id="result-summary" class="result-summary" style="display: none;">
            <h3>📊 诊断结果汇总</h3>
            <div id="result-items"></div>
        </div>
    </div>
    
    <div class="diagnosis-panel">
        <h2>📺 诊断控制台</h2>
        <div id="console-output" class="console-output">
            🔍 API连接诊断工具已加载...
            
            点击"开始诊断"按钮开始执行诊断。
            
            诊断将包括：
            1. 基本网络连接测试
            2. API端点可用性测试
            3. API密钥验证测试
            4. CORS和权限检查
            5. 真实API调用模拟
            6. 诊断报告生成
        </div>
    </div>
    
    <script>
        // 控制台输出管理
        let consoleOutput = '';
        let diagnosisResults = {};
        
        // 添加日志到控制台
        function addToConsole(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : '📝';
            const logMessage = `[${timestamp}] ${prefix} ${message}\n`;
            
            consoleOutput += logMessage;
            document.getElementById('console-output').textContent = consoleOutput;
            
            // 自动滚动到底部
            const consoleElement = document.getElementById('console-output');
            consoleElement.scrollTop = consoleElement.scrollHeight;
        }
        
        // 清空控制台
        function clearConsole() {
            consoleOutput = '';
            document.getElementById('console-output').textContent = '控制台已清空';
            document.getElementById('result-summary').style.display = 'none';
            updateStatus('准备就绪', 'success');
        }
        
        // 更新状态显示
        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('status-display');
            const indicator = statusElement.querySelector('.status-indicator');
            
            indicator.className = `status-indicator status-${type}`;
            statusElement.innerHTML = `<p><span class="status-indicator status-${type}"></span>${message}</p>`;
        }
        
        // 开始诊断
        async function startDiagnosis() {
            updateStatus('正在执行诊断...', 'running');
            addToConsole('🚀 开始执行API连接诊断...', 'info');
            
            try {
                // 执行所有诊断步骤
                const results = await runAllDiagnostics();
                
                // 保存结果到全局变量
                diagnosisResults = results;
                
                // 显示结果汇总
                displayResults(results);
                
                updateStatus('诊断完成！', 'success');
                addToConsole('🎯 诊断完成！', 'success');
                
            } catch (error) {
                updateStatus('诊断过程中发生错误', 'error');
                addToConsole(`❌ 诊断失败: ${error.message}`, 'error');
                console.error('诊断错误详情:', error);
            }
        }
        
        // 执行所有诊断
        async function runAllDiagnostics() {
            addToConsole('🚀 开始执行API连接诊断...', 'info');
            
            const results = {};
            
            try {
                addToConsole('📡 1. 测试基本网络连接...', 'info');
                results.basicConnectivity = await testBasicConnectivity();
                
                addToConsole('🔗 2. 测试API端点可用性...', 'info');
                results.apiEndpoints = await testAPIEndpoints();
                
                addToConsole('🔑 3. 测试API密钥验证...', 'info');
                results.apiKeyValidation = await testAPIKeyValidation();
                
                addToConsole('🚫 4. 检查CORS和权限...', 'info');
                results.corsCheck = await checkCORSAndPermissions();
                
                addToConsole('🎯 5. 模拟真实API调用...', 'info');
                results.realAPICall = await simulateRealAPICall();
                
                addToConsole('📊 6. 生成诊断报告...', 'info');
                const report = generateDiagnosisReport(results);
                
                addToConsole('🎯 诊断完成！', 'success');
                return results;
                
            } catch (error) {
                addToConsole(`❌ 诊断过程中发生错误: ${error.message}`, 'error');
                console.error('诊断错误详情:', error);
                return null;
            }
        }
        
        // 1. 测试基本网络连接
        async function testBasicConnectivity() {
            addToConsole('📡 测试基本网络连接...', 'info');
            
            try {
                // 测试DNS解析
                const testUrl = 'https://lboneapi.longbridge-inc.com/';
                addToConsole(`测试URL: ${testUrl}`, 'info');
                
                const response = await fetch(testUrl, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'User-Agent': 'LongPort-AI-Assistant/1.3.1'
                    }
                });
                
                addToConsole(`✅ 基本连接成功，状态码: ${response.status}`, 'success');
                addToConsole(`响应头: ${JSON.stringify(Object.fromEntries(response.headers.entries()))}`, 'info');
                
                return true;
            } catch (error) {
                addToConsole(`❌ 基本连接失败: ${error.message}`, 'error');
                return false;
            }
        }
        
        // 2. 测试API端点可用性
        async function testAPIEndpoints() {
            addToConsole('🔗 测试API端点可用性...', 'info');
            
            const baseUrl = 'https://lboneapi.longbridge-inc.com/';
            const endpoints = [
                '',
                'api/',
                'v1/',
                'chat/',
                'completions/',
                'optimize/',
                'text/',
                'ai/',
                'optimize_text/',
                'text_optimization/',
                'professional_optimization/',
                'grammar_optimization/'
            ];
            
            const results = [];
            
            for (const endpoint of endpoints) {
                try {
                    const url = baseUrl + endpoint;
                    addToConsole(`测试端点: ${url}`, 'info');
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        mode: 'cors',
                        headers: {
                            'User-Agent': 'LongPort-AI-Assistant/1.3.1'
                        }
                    });
                    
                    const result = {
                        endpoint: endpoint,
                        url: url,
                        status: response.status,
                        statusText: response.statusText,
                        contentType: response.headers.get('content-type'),
                        available: response.ok
                    };
                    
                    results.push(result);
                    
                    if (response.ok) {
                        addToConsole(`✅ ${endpoint} - 可用 (${response.status})`, 'success');
                    } else {
                        addToConsole(`⚠️ ${endpoint} - 不可用 (${response.status} ${response.statusText})`, 'warning');
                    }
                    
                } catch (error) {
                    addToConsole(`❌ ${endpoint} - 连接失败: ${error.message}`, 'error');
                    results.push({
                        endpoint: endpoint,
                        url: baseUrl + endpoint,
                        status: 'ERROR',
                        statusText: error.message,
                        contentType: null,
                        available: false
                    });
                }
                
                // 添加延迟避免请求过快
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            return results;
        }
        
        // 3. 测试API密钥验证
        async function testAPIKeyValidation() {
            addToConsole('🔑 测试API密钥验证...', 'info');
            
            const testConfig = {
                apiUrl: 'https://lboneapi.longbridge-inc.com/',
                apiKey: 'sk-7jSHih7SXoQcjMekQyTd3urc2G2BdtVzrzzdI6MotEpfWhyM'
            };
            
            try {
                // 构建测试请求
                const testRequest = {
                    text: '这是一个测试文本，用于验证API连接。',
                    site_type: 'longport',
                    optimization_type: 'professional_optimization',
                    language: 'zh-CN',
                    style: 'professional_financial',
                    requirements: {
                        preserve_semantics: true,
                        grammar_check: true,
                        style_optimization: true,
                        length_similarity: true,
                        professional_tone: true,
                        clarity_enhancement: true
                    }
                };
                
                addToConsole('测试请求参数:', 'info');
                addToConsole(JSON.stringify(testRequest, null, 2), 'info');
                
                // 尝试不同的请求方法
                const methods = ['POST', 'PUT', 'PATCH'];
                
                for (const method of methods) {
                    try {
                        addToConsole(`\n尝试 ${method} 请求...`, 'info');
                        
                        const response = await fetch(testConfig.apiUrl, {
                            method: method,
                            mode: 'cors',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${testConfig.apiKey}`,
                                'Accept': 'application/json',
                                'User-Agent': 'LongPort-AI-Assistant/1.3.1'
                            },
                            body: method !== 'GET' ? JSON.stringify(testRequest) : undefined
                        });
                        
                        addToConsole(`${method} 请求状态: ${response.status} ${response.statusText}`, 'info');
                        addToConsole(`响应头: ${JSON.stringify(Object.fromEntries(response.headers.entries()))}`, 'info');
                        
                        if (response.ok) {
                            addToConsole(`✅ ${method} 请求成功！`, 'success');
                            
                            // 尝试读取响应内容
                            try {
                                const responseText = await response.text();
                                addToConsole(`响应内容预览: ${responseText.substring(0, 200)}`, 'info');
                            } catch (readError) {
                                addToConsole(`无法读取响应内容: ${readError.message}`, 'warning');
                            }
                            
                            return { success: true, method: method, status: response.status };
                        } else {
                            addToConsole(`⚠️ ${method} 请求失败: ${response.status} ${response.statusText}`, 'warning');
                            
                            // 尝试读取错误响应
                            try {
                                const errorText = await response.text();
                                addToConsole(`错误响应: ${errorText.substring(0, 200)}`, 'info');
                            } catch (readError) {
                                addToConsole(`无法读取错误响应: ${readError.message}`, 'warning');
                            }
                        }
                        
                    } catch (error) {
                        addToConsole(`❌ ${method} 请求异常: ${error.message}`, 'error');
                    }
                }
                
                return { success: false, error: '所有请求方法都失败了' };
                
            } catch (error) {
                addToConsole(`❌ API密钥验证测试失败: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }
        
        // 4. 检查CORS和权限问题
        async function checkCORSAndPermissions() {
            addToConsole('🚫 检查CORS和权限...', 'info');
            
            try {
                // 测试预检请求
                const testUrl = 'https://lboneapi.longbridge-inc.com/';
                
                addToConsole('测试预检请求...', 'info');
                
                const preflightResponse = await fetch(testUrl, {
                    method: 'OPTIONS',
                    mode: 'cors',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type, Authorization'
                    }
                });
                
                addToConsole(`预检请求状态: ${preflightResponse.status}`, 'info');
                addToConsole('CORS相关响应头:', 'info');
                addToConsole(`- Access-Control-Allow-Origin: ${preflightResponse.headers.get('Access-Control-Allow-Origin')}`, 'info');
                addToConsole(`- Access-Control-Allow-Methods: ${preflightResponse.headers.get('Access-Control-Allow-Methods')}`, 'info');
                addToConsole(`- Access-Control-Allow-Headers: ${preflightResponse.headers.get('Access-Control-Allow-Headers')}`, 'info');
                
                return true;
            } catch (error) {
                addToConsole(`❌ CORS检查失败: ${error.message}`, 'error');
                return false;
            }
        }
        
        // 5. 模拟真实的API调用流程
        async function simulateRealAPICall() {
            addToConsole('🎯 模拟真实的API调用流程...', 'info');
            
            try {
                // 模拟background.js中的callCompanyAPI函数
                const mockText = '这是一个需要优化的金融文案，包含投资建议和风险提示。';
                const mockSiteType = 'longport';
                
                addToConsole(`模拟文本: ${mockText}`, 'info');
                addToConsole(`网站类型: ${mockSiteType}`, 'info');
                
                // 构建请求体
                const requestBody = {
                    text: mockText,
                    site_type: mockSiteType,
                    optimization_type: 'professional_optimization',
                    language: 'zh-CN',
                    style: 'professional_financial',
                    requirements: {
                        preserve_semantics: true,
                        grammar_check: true,
                        style_optimization: true,
                        length_similarity: true,
                        professional_tone: true,
                        clarity_enhancement: true
                    }
                };
                
                addToConsole('请求体:', 'info');
                addToConsole(JSON.stringify(requestBody, null, 2), 'info');
                
                // 尝试发送请求
                const response = await fetch('https://lboneapi.longbridge-inc.com/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer sk-7jSHih7SXoQcjMekQyTd3urc2G2BdtVzrzzdI6MotEpfWhyM',
                        'Accept': 'application/json',
                        'User-Agent': 'LongPort-AI-Assistant/1.3.1'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                addToConsole(`模拟API调用状态: ${response.status} ${response.statusText}`, 'info');
                addToConsole(`响应头: ${JSON.stringify(Object.fromEntries(response.headers.entries()))}`, 'info');
                
                if (response.ok) {
                    addToConsole('✅ 模拟API调用成功！', 'success');
                    
                    try {
                        const responseData = await response.json();
                        addToConsole(`响应数据: ${JSON.stringify(responseData, null, 2)}`, 'info');
                    } catch (jsonError) {
                        const responseText = await response.text();
                        addToConsole(`响应文本: ${responseText.substring(0, 200)}`, 'info');
                    }
                    
                    return true;
                } else {
                    addToConsole(`⚠️ 模拟API调用失败: ${response.status} ${response.statusText}`, 'warning');
                    
                    try {
                        const errorText = await response.text();
                        addToConsole(`错误详情: ${errorText.substring(0, 200)}`, 'info');
                    } catch (readError) {
                        addToConsole(`无法读取错误详情: ${readError.message}`, 'warning');
                    }
                    
                    return false;
                }
                
            } catch (error) {
                addToConsole(`❌ 模拟API调用失败: ${error.message}`, 'error');
                return false;
            }
        }
        
        // 6. 生成诊断报告
        function generateDiagnosisReport(results) {
            addToConsole('📊 生成诊断报告...', 'info');
            
            const report = {
                timestamp: new Date().toISOString(),
                basicConnectivity: results.basicConnectivity,
                apiEndpoints: results.apiEndpoints,
                apiKeyValidation: results.apiKeyValidation,
                corsCheck: results.corsCheck,
                realAPICall: results.realAPICall,
                summary: '',
                recommendations: []
            };
            
            // 分析结果
            if (!results.basicConnectivity) {
                report.summary = '❌ 基本网络连接失败';
                report.recommendations.push('检查网络连接和DNS设置');
            } else if (!results.apiKeyValidation.success) {
                report.summary = '⚠️ 网络连接正常，但API调用失败';
                report.recommendations.push('检查API密钥是否有效');
                report.recommendations.push('验证API端点是否正确');
                report.recommendations.push('确认API权限设置');
            } else if (!results.realAPICall) {
                report.summary = '⚠️ API配置正确，但实际调用失败';
                report.recommendations.push('检查请求格式是否符合API要求');
                report.recommendations.push('验证API的请求参数');
            } else {
                report.summary = '✅ API连接正常，功能完整';
            }
            
            addToConsole('🔍 诊断报告:', 'info');
            addToConsole(`时间: ${report.timestamp}`, 'info');
            addToConsole(`总结: ${report.summary}`, 'info');
            addToConsole('建议:', 'info');
            report.recommendations.forEach((rec, index) => {
                addToConsole(`${index + 1}. ${rec}`, 'info');
            });
            
            return report;
        }
        
        // 显示诊断结果
        function displayResults(results) {
            const resultSummary = document.getElementById('result-summary');
            const resultItems = document.getElementById('result-items');
            
            resultItems.innerHTML = '';
            
            // 基本连接测试结果
            addResultItem('基本网络连接', results.basicConnectivity ? 'success' : 'error', 
                results.basicConnectivity ? '网络连接正常' : '网络连接失败');
            
            // API端点测试结果
            if (results.apiEndpoints) {
                const availableEndpoints = results.apiEndpoints.filter(ep => ep.available);
                addResultItem('API端点可用性', availableEndpoints.length > 0 ? 'success' : 'warning',
                    `找到 ${availableEndpoints.length} 个可用端点`);
            }
            
            // API密钥验证结果
            if (results.apiKeyValidation) {
                addResultItem('API密钥验证', results.apiKeyValidation.success ? 'success' : 'error',
                    results.apiKeyValidation.success ? 'API密钥有效' : 'API密钥验证失败');
            }
            
            // CORS检查结果
            addResultItem('CORS和权限检查', results.corsCheck ? 'success' : 'warning',
                results.corsCheck ? 'CORS检查通过' : 'CORS检查失败');
            
            // 真实API调用结果
            addResultItem('真实API调用', results.realAPICall ? 'success' : 'error',
                results.realAPICall ? 'API调用成功' : 'API调用失败');
            
            resultSummary.style.display = 'block';
        }
        
        // 添加结果项
        function addResultItem(title, type, message) {
            const resultItems = document.getElementById('result-items');
            const item = document.createElement('div');
            item.className = `result-item ${type}`;
            
            const statusIcon = type === 'success' ? '✅' : type === 'warning' ? '⚠️' : '❌';
            item.innerHTML = `
                <span style="font-weight: bold; margin-right: 10px;">${statusIcon} ${title}</span>
                <span>${message}</span>
            `;
            
            resultItems.appendChild(item);
        }
        
        // 导出结果
        function exportResults() {
            const data = {
                timestamp: new Date().toISOString(),
                consoleOutput: consoleOutput,
                results: diagnosisResults
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `api-diagnosis-results-${new Date().toISOString().slice(0, 19)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            addToConsole('📥 诊断结果已导出', 'success');
        }
        
        // 显示详细说明
        function showInstructions() {
            addToConsole(`
📖 API连接诊断详细说明

本工具将执行以下诊断步骤：

1. 📡 基本网络连接测试
   - 测试DNS解析
   - 验证服务器可达性
   - 检查网络连接状态

2. 🔗 API端点可用性测试
   - 测试多个可能的API端点
   - 验证端点响应状态
   - 确定可用的API路径

3. 🔑 API密钥验证测试
   - 测试API密钥有效性
   - 验证认证机制
   - 检查权限设置

4. 🚫 CORS和权限检查
   - 测试跨域请求支持
   - 验证预检请求响应
   - 检查访问控制设置

5. 🎯 真实API调用模拟
   - 模拟完整的API调用流程
   - 验证请求格式正确性
   - 测试响应处理逻辑

诊断完成后，将生成详细的报告和建议。
            `, 'info');
        }
        
        // 重写console.log以捕获输出
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addToConsole(args.join(' '), 'info');
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };
        
        // 初始化
        addToConsole('🔍 API连接诊断工具已加载，准备就绪', 'success');
    </script>
    
    <!-- 诊断逻辑已集成到本文件中，无需外部脚本 -->
</body>
</html>
