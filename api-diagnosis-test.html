<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIè¿æ¥è¯Šæ–­æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .diagnosis-panel {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .diagnosis-panel h2 {
            color: #333;
            margin-top: 0;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .console-output {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 20px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-running {
            background-color: #ffc107;
            animation: pulse 1.5s infinite;
        }
        
        .status-success {
            background-color: #28a745;
        }
        
        .status-error {
            background-color: #dc3545;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .result-summary {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .result-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #dee2e6;
        }
        
        .result-item.success {
            border-left-color: #28a745;
        }
        
        .result-item.warning {
            border-left-color: #ffc107;
        }
        
        .result-item.error {
            border-left-color: #dc3545;
        }
        
        .instructions {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 0 8px 8px 0;
        }
        
        .instructions h3 {
            margin-top: 0;
            color: #1976d2;
        }
        
        .instructions ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ” APIè¿æ¥è¯Šæ–­å·¥å…·</h1>
        <p>è¯Šæ–­ä¸ºä»€ä¹ˆAPIå¹³å°æ²¡æœ‰å‘ç°è¯·æ±‚æ¬¡æ•°å¢åŠ </p>
    </div>
    
    <div class="instructions">
        <h3>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h3>
        <ol>
            <li><strong>ç‚¹å‡»"å¼€å§‹è¯Šæ–­"æŒ‰é’®</strong> - è‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰è¯Šæ–­æ­¥éª¤</li>
            <li><strong>æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º</strong> - åœ¨ä¸‹æ–¹æ§åˆ¶å°åŒºåŸŸæŸ¥çœ‹è¯¦ç»†è¯Šæ–­ä¿¡æ¯</li>
            <li><strong>åˆ†æè¯Šæ–­ç»“æœ</strong> - æ ¹æ®ç»“æœç¡®å®šé—®é¢˜æ‰€åœ¨</li>
            <li><strong>æŸ¥çœ‹å»ºè®®</strong> - æŒ‰ç…§å»ºè®®è¿›è¡Œç›¸åº”çš„ä¿®å¤</li>
        </ol>
    </div>
    
    <div class="diagnosis-panel">
        <h2>ğŸš€ è¯Šæ–­æ§åˆ¶é¢æ¿</h2>
        
        <div class="button-group">
            <button class="btn btn-primary" onclick="startDiagnosis()">
                ğŸ” å¼€å§‹è¯Šæ–­
            </button>
            <button class="btn btn-secondary" onclick="clearConsole()">
                ğŸ—‘ï¸ æ¸…ç©ºæ§åˆ¶å°
            </button>
            <button class="btn btn-success" onclick="exportResults()">
                ğŸ“¥ å¯¼å‡ºç»“æœ
            </button>
            <button class="btn btn-warning" onclick="showInstructions()">
                ğŸ“– è¯¦ç»†è¯´æ˜
            </button>
        </div>
        
        <div id="status-display">
            <p><span class="status-indicator status-success"></span>å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»"å¼€å§‹è¯Šæ–­"æŒ‰é’®å¼€å§‹</p>
        </div>
        
        <div id="result-summary" class="result-summary" style="display: none;">
            <h3>ğŸ“Š è¯Šæ–­ç»“æœæ±‡æ€»</h3>
            <div id="result-items"></div>
        </div>
    </div>
    
    <div class="diagnosis-panel">
        <h2>ğŸ“º è¯Šæ–­æ§åˆ¶å°</h2>
        <div id="console-output" class="console-output">
            ğŸ” APIè¿æ¥è¯Šæ–­å·¥å…·å·²åŠ è½½...
            
            ç‚¹å‡»"å¼€å§‹è¯Šæ–­"æŒ‰é’®å¼€å§‹æ‰§è¡Œè¯Šæ–­ã€‚
            
            è¯Šæ–­å°†åŒ…æ‹¬ï¼š
            1. åŸºæœ¬ç½‘ç»œè¿æ¥æµ‹è¯•
            2. APIç«¯ç‚¹å¯ç”¨æ€§æµ‹è¯•
            3. APIå¯†é’¥éªŒè¯æµ‹è¯•
            4. CORSå’Œæƒé™æ£€æŸ¥
            5. çœŸå®APIè°ƒç”¨æ¨¡æ‹Ÿ
            6. è¯Šæ–­æŠ¥å‘Šç”Ÿæˆ
        </div>
    </div>
    
    <script>
        // æ§åˆ¶å°è¾“å‡ºç®¡ç†
        let consoleOutput = '';
        let diagnosisResults = {};
        
        // æ·»åŠ æ—¥å¿—åˆ°æ§åˆ¶å°
        function addToConsole(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'ğŸ“';
            const logMessage = `[${timestamp}] ${prefix} ${message}\n`;
            
            consoleOutput += logMessage;
            document.getElementById('console-output').textContent = consoleOutput;
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            const consoleElement = document.getElementById('console-output');
            consoleElement.scrollTop = consoleElement.scrollHeight;
        }
        
        // æ¸…ç©ºæ§åˆ¶å°
        function clearConsole() {
            consoleOutput = '';
            document.getElementById('console-output').textContent = 'æ§åˆ¶å°å·²æ¸…ç©º';
            document.getElementById('result-summary').style.display = 'none';
            updateStatus('å‡†å¤‡å°±ç»ª', 'success');
        }
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('status-display');
            const indicator = statusElement.querySelector('.status-indicator');
            
            indicator.className = `status-indicator status-${type}`;
            statusElement.innerHTML = `<p><span class="status-indicator status-${type}"></span>${message}</p>`;
        }
        
        // å¼€å§‹è¯Šæ–­
        async function startDiagnosis() {
            updateStatus('æ­£åœ¨æ‰§è¡Œè¯Šæ–­...', 'running');
            addToConsole('ğŸš€ å¼€å§‹æ‰§è¡ŒAPIè¿æ¥è¯Šæ–­...', 'info');
            
            try {
                // æ‰§è¡Œæ‰€æœ‰è¯Šæ–­æ­¥éª¤
                const results = await runAllDiagnostics();
                
                // ä¿å­˜ç»“æœåˆ°å…¨å±€å˜é‡
                diagnosisResults = results;
                
                // æ˜¾ç¤ºç»“æœæ±‡æ€»
                displayResults(results);
                
                updateStatus('è¯Šæ–­å®Œæˆï¼', 'success');
                addToConsole('ğŸ¯ è¯Šæ–­å®Œæˆï¼', 'success');
                
            } catch (error) {
                updateStatus('è¯Šæ–­è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯', 'error');
                addToConsole(`âŒ è¯Šæ–­å¤±è´¥: ${error.message}`, 'error');
                console.error('è¯Šæ–­é”™è¯¯è¯¦æƒ…:', error);
            }
        }
        
        // æ‰§è¡Œæ‰€æœ‰è¯Šæ–­
        async function runAllDiagnostics() {
            addToConsole('ğŸš€ å¼€å§‹æ‰§è¡ŒAPIè¿æ¥è¯Šæ–­...', 'info');
            
            const results = {};
            
            try {
                addToConsole('ğŸ“¡ 1. æµ‹è¯•åŸºæœ¬ç½‘ç»œè¿æ¥...', 'info');
                results.basicConnectivity = await testBasicConnectivity();
                
                addToConsole('ğŸ”— 2. æµ‹è¯•APIç«¯ç‚¹å¯ç”¨æ€§...', 'info');
                results.apiEndpoints = await testAPIEndpoints();
                
                addToConsole('ğŸ”‘ 3. æµ‹è¯•APIå¯†é’¥éªŒè¯...', 'info');
                results.apiKeyValidation = await testAPIKeyValidation();
                
                addToConsole('ğŸš« 4. æ£€æŸ¥CORSå’Œæƒé™...', 'info');
                results.corsCheck = await checkCORSAndPermissions();
                
                addToConsole('ğŸ¯ 5. æ¨¡æ‹ŸçœŸå®APIè°ƒç”¨...', 'info');
                results.realAPICall = await simulateRealAPICall();
                
                addToConsole('ğŸ“Š 6. ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š...', 'info');
                const report = generateDiagnosisReport(results);
                
                addToConsole('ğŸ¯ è¯Šæ–­å®Œæˆï¼', 'success');
                return results;
                
            } catch (error) {
                addToConsole(`âŒ è¯Šæ–­è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`, 'error');
                console.error('è¯Šæ–­é”™è¯¯è¯¦æƒ…:', error);
                return null;
            }
        }
        
        // 1. æµ‹è¯•åŸºæœ¬ç½‘ç»œè¿æ¥
        async function testBasicConnectivity() {
            addToConsole('ğŸ“¡ æµ‹è¯•åŸºæœ¬ç½‘ç»œè¿æ¥...', 'info');
            
            try {
                // æµ‹è¯•DNSè§£æ
                const testUrl = 'https://lboneapi.longbridge-inc.com/';
                addToConsole(`æµ‹è¯•URL: ${testUrl}`, 'info');
                
                const response = await fetch(testUrl, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'User-Agent': 'LongPort-AI-Assistant/1.3.1'
                    }
                });
                
                addToConsole(`âœ… åŸºæœ¬è¿æ¥æˆåŠŸï¼ŒçŠ¶æ€ç : ${response.status}`, 'success');
                addToConsole(`å“åº”å¤´: ${JSON.stringify(Object.fromEntries(response.headers.entries()))}`, 'info');
                
                return true;
            } catch (error) {
                addToConsole(`âŒ åŸºæœ¬è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }
        
        // 2. æµ‹è¯•APIç«¯ç‚¹å¯ç”¨æ€§
        async function testAPIEndpoints() {
            addToConsole('ğŸ”— æµ‹è¯•APIç«¯ç‚¹å¯ç”¨æ€§...', 'info');
            
            const baseUrl = 'https://lboneapi.longbridge-inc.com/';
            const endpoints = [
                '',
                'api/',
                'v1/',
                'chat/',
                'completions/',
                'optimize/',
                'text/',
                'ai/',
                'optimize_text/',
                'text_optimization/',
                'professional_optimization/',
                'grammar_optimization/'
            ];
            
            const results = [];
            
            for (const endpoint of endpoints) {
                try {
                    const url = baseUrl + endpoint;
                    addToConsole(`æµ‹è¯•ç«¯ç‚¹: ${url}`, 'info');
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        mode: 'cors',
                        headers: {
                            'User-Agent': 'LongPort-AI-Assistant/1.3.1'
                        }
                    });
                    
                    const result = {
                        endpoint: endpoint,
                        url: url,
                        status: response.status,
                        statusText: response.statusText,
                        contentType: response.headers.get('content-type'),
                        available: response.ok
                    };
                    
                    results.push(result);
                    
                    if (response.ok) {
                        addToConsole(`âœ… ${endpoint} - å¯ç”¨ (${response.status})`, 'success');
                    } else {
                        addToConsole(`âš ï¸ ${endpoint} - ä¸å¯ç”¨ (${response.status} ${response.statusText})`, 'warning');
                    }
                    
                } catch (error) {
                    addToConsole(`âŒ ${endpoint} - è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                    results.push({
                        endpoint: endpoint,
                        url: baseUrl + endpoint,
                        status: 'ERROR',
                        statusText: error.message,
                        contentType: null,
                        available: false
                    });
                }
                
                // æ·»åŠ å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡å¿«
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            return results;
        }
        
        // 3. æµ‹è¯•APIå¯†é’¥éªŒè¯
        async function testAPIKeyValidation() {
            addToConsole('ğŸ”‘ æµ‹è¯•APIå¯†é’¥éªŒè¯...', 'info');
            
            const testConfig = {
                apiUrl: 'https://lboneapi.longbridge-inc.com/',
                apiKey: 'sk-7jSHih7SXoQcjMekQyTd3urc2G2BdtVzrzzdI6MotEpfWhyM'
            };
            
            try {
                // æ„å»ºæµ‹è¯•è¯·æ±‚
                const testRequest = {
                    text: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡æœ¬ï¼Œç”¨äºéªŒè¯APIè¿æ¥ã€‚',
                    site_type: 'longport',
                    optimization_type: 'professional_optimization',
                    language: 'zh-CN',
                    style: 'professional_financial',
                    requirements: {
                        preserve_semantics: true,
                        grammar_check: true,
                        style_optimization: true,
                        length_similarity: true,
                        professional_tone: true,
                        clarity_enhancement: true
                    }
                };
                
                addToConsole('æµ‹è¯•è¯·æ±‚å‚æ•°:', 'info');
                addToConsole(JSON.stringify(testRequest, null, 2), 'info');
                
                // å°è¯•ä¸åŒçš„è¯·æ±‚æ–¹æ³•
                const methods = ['POST', 'PUT', 'PATCH'];
                
                for (const method of methods) {
                    try {
                        addToConsole(`\nå°è¯• ${method} è¯·æ±‚...`, 'info');
                        
                        const response = await fetch(testConfig.apiUrl, {
                            method: method,
                            mode: 'cors',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${testConfig.apiKey}`,
                                'Accept': 'application/json',
                                'User-Agent': 'LongPort-AI-Assistant/1.3.1'
                            },
                            body: method !== 'GET' ? JSON.stringify(testRequest) : undefined
                        });
                        
                        addToConsole(`${method} è¯·æ±‚çŠ¶æ€: ${response.status} ${response.statusText}`, 'info');
                        addToConsole(`å“åº”å¤´: ${JSON.stringify(Object.fromEntries(response.headers.entries()))}`, 'info');
                        
                        if (response.ok) {
                            addToConsole(`âœ… ${method} è¯·æ±‚æˆåŠŸï¼`, 'success');
                            
                            // å°è¯•è¯»å–å“åº”å†…å®¹
                            try {
                                const responseText = await response.text();
                                addToConsole(`å“åº”å†…å®¹é¢„è§ˆ: ${responseText.substring(0, 200)}`, 'info');
                            } catch (readError) {
                                addToConsole(`æ— æ³•è¯»å–å“åº”å†…å®¹: ${readError.message}`, 'warning');
                            }
                            
                            return { success: true, method: method, status: response.status };
                        } else {
                            addToConsole(`âš ï¸ ${method} è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`, 'warning');
                            
                            // å°è¯•è¯»å–é”™è¯¯å“åº”
                            try {
                                const errorText = await response.text();
                                addToConsole(`é”™è¯¯å“åº”: ${errorText.substring(0, 200)}`, 'info');
                            } catch (readError) {
                                addToConsole(`æ— æ³•è¯»å–é”™è¯¯å“åº”: ${readError.message}`, 'warning');
                            }
                        }
                        
                    } catch (error) {
                        addToConsole(`âŒ ${method} è¯·æ±‚å¼‚å¸¸: ${error.message}`, 'error');
                    }
                }
                
                return { success: false, error: 'æ‰€æœ‰è¯·æ±‚æ–¹æ³•éƒ½å¤±è´¥äº†' };
                
            } catch (error) {
                addToConsole(`âŒ APIå¯†é’¥éªŒè¯æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }
        
        // 4. æ£€æŸ¥CORSå’Œæƒé™é—®é¢˜
        async function checkCORSAndPermissions() {
            addToConsole('ğŸš« æ£€æŸ¥CORSå’Œæƒé™...', 'info');
            
            try {
                // æµ‹è¯•é¢„æ£€è¯·æ±‚
                const testUrl = 'https://lboneapi.longbridge-inc.com/';
                
                addToConsole('æµ‹è¯•é¢„æ£€è¯·æ±‚...', 'info');
                
                const preflightResponse = await fetch(testUrl, {
                    method: 'OPTIONS',
                    mode: 'cors',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type, Authorization'
                    }
                });
                
                addToConsole(`é¢„æ£€è¯·æ±‚çŠ¶æ€: ${preflightResponse.status}`, 'info');
                addToConsole('CORSç›¸å…³å“åº”å¤´:', 'info');
                addToConsole(`- Access-Control-Allow-Origin: ${preflightResponse.headers.get('Access-Control-Allow-Origin')}`, 'info');
                addToConsole(`- Access-Control-Allow-Methods: ${preflightResponse.headers.get('Access-Control-Allow-Methods')}`, 'info');
                addToConsole(`- Access-Control-Allow-Headers: ${preflightResponse.headers.get('Access-Control-Allow-Headers')}`, 'info');
                
                return true;
            } catch (error) {
                addToConsole(`âŒ CORSæ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }
        
        // 5. æ¨¡æ‹ŸçœŸå®çš„APIè°ƒç”¨æµç¨‹
        async function simulateRealAPICall() {
            addToConsole('ğŸ¯ æ¨¡æ‹ŸçœŸå®çš„APIè°ƒç”¨æµç¨‹...', 'info');
            
            try {
                // æ¨¡æ‹Ÿbackground.jsä¸­çš„callCompanyAPIå‡½æ•°
                const mockText = 'è¿™æ˜¯ä¸€ä¸ªéœ€è¦ä¼˜åŒ–çš„é‡‘èæ–‡æ¡ˆï¼ŒåŒ…å«æŠ•èµ„å»ºè®®å’Œé£é™©æç¤ºã€‚';
                const mockSiteType = 'longport';
                
                addToConsole(`æ¨¡æ‹Ÿæ–‡æœ¬: ${mockText}`, 'info');
                addToConsole(`ç½‘ç«™ç±»å‹: ${mockSiteType}`, 'info');
                
                // æ„å»ºè¯·æ±‚ä½“
                const requestBody = {
                    text: mockText,
                    site_type: mockSiteType,
                    optimization_type: 'professional_optimization',
                    language: 'zh-CN',
                    style: 'professional_financial',
                    requirements: {
                        preserve_semantics: true,
                        grammar_check: true,
                        style_optimization: true,
                        length_similarity: true,
                        professional_tone: true,
                        clarity_enhancement: true
                    }
                };
                
                addToConsole('è¯·æ±‚ä½“:', 'info');
                addToConsole(JSON.stringify(requestBody, null, 2), 'info');
                
                // å°è¯•å‘é€è¯·æ±‚
                const response = await fetch('https://lboneapi.longbridge-inc.com/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer sk-7jSHih7SXoQcjMekQyTd3urc2G2BdtVzrzzdI6MotEpfWhyM',
                        'Accept': 'application/json',
                        'User-Agent': 'LongPort-AI-Assistant/1.3.1'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                addToConsole(`æ¨¡æ‹ŸAPIè°ƒç”¨çŠ¶æ€: ${response.status} ${response.statusText}`, 'info');
                addToConsole(`å“åº”å¤´: ${JSON.stringify(Object.fromEntries(response.headers.entries()))}`, 'info');
                
                if (response.ok) {
                    addToConsole('âœ… æ¨¡æ‹ŸAPIè°ƒç”¨æˆåŠŸï¼', 'success');
                    
                    try {
                        const responseData = await response.json();
                        addToConsole(`å“åº”æ•°æ®: ${JSON.stringify(responseData, null, 2)}`, 'info');
                    } catch (jsonError) {
                        const responseText = await response.text();
                        addToConsole(`å“åº”æ–‡æœ¬: ${responseText.substring(0, 200)}`, 'info');
                    }
                    
                    return true;
                } else {
                    addToConsole(`âš ï¸ æ¨¡æ‹ŸAPIè°ƒç”¨å¤±è´¥: ${response.status} ${response.statusText}`, 'warning');
                    
                    try {
                        const errorText = await response.text();
                        addToConsole(`é”™è¯¯è¯¦æƒ…: ${errorText.substring(0, 200)}`, 'info');
                    } catch (readError) {
                        addToConsole(`æ— æ³•è¯»å–é”™è¯¯è¯¦æƒ…: ${readError.message}`, 'warning');
                    }
                    
                    return false;
                }
                
            } catch (error) {
                addToConsole(`âŒ æ¨¡æ‹ŸAPIè°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }
        
        // 6. ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
        function generateDiagnosisReport(results) {
            addToConsole('ğŸ“Š ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š...', 'info');
            
            const report = {
                timestamp: new Date().toISOString(),
                basicConnectivity: results.basicConnectivity,
                apiEndpoints: results.apiEndpoints,
                apiKeyValidation: results.apiKeyValidation,
                corsCheck: results.corsCheck,
                realAPICall: results.realAPICall,
                summary: '',
                recommendations: []
            };
            
            // åˆ†æç»“æœ
            if (!results.basicConnectivity) {
                report.summary = 'âŒ åŸºæœ¬ç½‘ç»œè¿æ¥å¤±è´¥';
                report.recommendations.push('æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒDNSè®¾ç½®');
            } else if (!results.apiKeyValidation.success) {
                report.summary = 'âš ï¸ ç½‘ç»œè¿æ¥æ­£å¸¸ï¼Œä½†APIè°ƒç”¨å¤±è´¥';
                report.recommendations.push('æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æœ‰æ•ˆ');
                report.recommendations.push('éªŒè¯APIç«¯ç‚¹æ˜¯å¦æ­£ç¡®');
                report.recommendations.push('ç¡®è®¤APIæƒé™è®¾ç½®');
            } else if (!results.realAPICall) {
                report.summary = 'âš ï¸ APIé…ç½®æ­£ç¡®ï¼Œä½†å®é™…è°ƒç”¨å¤±è´¥';
                report.recommendations.push('æ£€æŸ¥è¯·æ±‚æ ¼å¼æ˜¯å¦ç¬¦åˆAPIè¦æ±‚');
                report.recommendations.push('éªŒè¯APIçš„è¯·æ±‚å‚æ•°');
            } else {
                report.summary = 'âœ… APIè¿æ¥æ­£å¸¸ï¼ŒåŠŸèƒ½å®Œæ•´';
            }
            
            addToConsole('ğŸ” è¯Šæ–­æŠ¥å‘Š:', 'info');
            addToConsole(`æ—¶é—´: ${report.timestamp}`, 'info');
            addToConsole(`æ€»ç»“: ${report.summary}`, 'info');
            addToConsole('å»ºè®®:', 'info');
            report.recommendations.forEach((rec, index) => {
                addToConsole(`${index + 1}. ${rec}`, 'info');
            });
            
            return report;
        }
        
        // æ˜¾ç¤ºè¯Šæ–­ç»“æœ
        function displayResults(results) {
            const resultSummary = document.getElementById('result-summary');
            const resultItems = document.getElementById('result-items');
            
            resultItems.innerHTML = '';
            
            // åŸºæœ¬è¿æ¥æµ‹è¯•ç»“æœ
            addResultItem('åŸºæœ¬ç½‘ç»œè¿æ¥', results.basicConnectivity ? 'success' : 'error', 
                results.basicConnectivity ? 'ç½‘ç»œè¿æ¥æ­£å¸¸' : 'ç½‘ç»œè¿æ¥å¤±è´¥');
            
            // APIç«¯ç‚¹æµ‹è¯•ç»“æœ
            if (results.apiEndpoints) {
                const availableEndpoints = results.apiEndpoints.filter(ep => ep.available);
                addResultItem('APIç«¯ç‚¹å¯ç”¨æ€§', availableEndpoints.length > 0 ? 'success' : 'warning',
                    `æ‰¾åˆ° ${availableEndpoints.length} ä¸ªå¯ç”¨ç«¯ç‚¹`);
            }
            
            // APIå¯†é’¥éªŒè¯ç»“æœ
            if (results.apiKeyValidation) {
                addResultItem('APIå¯†é’¥éªŒè¯', results.apiKeyValidation.success ? 'success' : 'error',
                    results.apiKeyValidation.success ? 'APIå¯†é’¥æœ‰æ•ˆ' : 'APIå¯†é’¥éªŒè¯å¤±è´¥');
            }
            
            // CORSæ£€æŸ¥ç»“æœ
            addResultItem('CORSå’Œæƒé™æ£€æŸ¥', results.corsCheck ? 'success' : 'warning',
                results.corsCheck ? 'CORSæ£€æŸ¥é€šè¿‡' : 'CORSæ£€æŸ¥å¤±è´¥');
            
            // çœŸå®APIè°ƒç”¨ç»“æœ
            addResultItem('çœŸå®APIè°ƒç”¨', results.realAPICall ? 'success' : 'error',
                results.realAPICall ? 'APIè°ƒç”¨æˆåŠŸ' : 'APIè°ƒç”¨å¤±è´¥');
            
            resultSummary.style.display = 'block';
        }
        
        // æ·»åŠ ç»“æœé¡¹
        function addResultItem(title, type, message) {
            const resultItems = document.getElementById('result-items');
            const item = document.createElement('div');
            item.className = `result-item ${type}`;
            
            const statusIcon = type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'âŒ';
            item.innerHTML = `
                <span style="font-weight: bold; margin-right: 10px;">${statusIcon} ${title}</span>
                <span>${message}</span>
            `;
            
            resultItems.appendChild(item);
        }
        
        // å¯¼å‡ºç»“æœ
        function exportResults() {
            const data = {
                timestamp: new Date().toISOString(),
                consoleOutput: consoleOutput,
                results: diagnosisResults
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `api-diagnosis-results-${new Date().toISOString().slice(0, 19)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            addToConsole('ğŸ“¥ è¯Šæ–­ç»“æœå·²å¯¼å‡º', 'success');
        }
        
        // æ˜¾ç¤ºè¯¦ç»†è¯´æ˜
        function showInstructions() {
            addToConsole(`
ğŸ“– APIè¿æ¥è¯Šæ–­è¯¦ç»†è¯´æ˜

æœ¬å·¥å…·å°†æ‰§è¡Œä»¥ä¸‹è¯Šæ–­æ­¥éª¤ï¼š

1. ğŸ“¡ åŸºæœ¬ç½‘ç»œè¿æ¥æµ‹è¯•
   - æµ‹è¯•DNSè§£æ
   - éªŒè¯æœåŠ¡å™¨å¯è¾¾æ€§
   - æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€

2. ğŸ”— APIç«¯ç‚¹å¯ç”¨æ€§æµ‹è¯•
   - æµ‹è¯•å¤šä¸ªå¯èƒ½çš„APIç«¯ç‚¹
   - éªŒè¯ç«¯ç‚¹å“åº”çŠ¶æ€
   - ç¡®å®šå¯ç”¨çš„APIè·¯å¾„

3. ğŸ”‘ APIå¯†é’¥éªŒè¯æµ‹è¯•
   - æµ‹è¯•APIå¯†é’¥æœ‰æ•ˆæ€§
   - éªŒè¯è®¤è¯æœºåˆ¶
   - æ£€æŸ¥æƒé™è®¾ç½®

4. ğŸš« CORSå’Œæƒé™æ£€æŸ¥
   - æµ‹è¯•è·¨åŸŸè¯·æ±‚æ”¯æŒ
   - éªŒè¯é¢„æ£€è¯·æ±‚å“åº”
   - æ£€æŸ¥è®¿é—®æ§åˆ¶è®¾ç½®

5. ğŸ¯ çœŸå®APIè°ƒç”¨æ¨¡æ‹Ÿ
   - æ¨¡æ‹Ÿå®Œæ•´çš„APIè°ƒç”¨æµç¨‹
   - éªŒè¯è¯·æ±‚æ ¼å¼æ­£ç¡®æ€§
   - æµ‹è¯•å“åº”å¤„ç†é€»è¾‘

è¯Šæ–­å®Œæˆåï¼Œå°†ç”Ÿæˆè¯¦ç»†çš„æŠ¥å‘Šå’Œå»ºè®®ã€‚
            `, 'info');
        }
        
        // é‡å†™console.logä»¥æ•è·è¾“å‡º
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addToConsole(args.join(' '), 'info');
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };
        
        // åˆå§‹åŒ–
        addToConsole('ğŸ” APIè¿æ¥è¯Šæ–­å·¥å…·å·²åŠ è½½ï¼Œå‡†å¤‡å°±ç»ª', 'success');
    </script>
    
    <!-- è¯Šæ–­é€»è¾‘å·²é›†æˆåˆ°æœ¬æ–‡ä»¶ä¸­ï¼Œæ— éœ€å¤–éƒ¨è„šæœ¬ -->
</body>
</html>
