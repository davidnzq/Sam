<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>真实API集成测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007AFF;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }
        .input-group {
            margin: 15px 0;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            resize: vertical;
        }
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background 0.3s;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result-box {
            margin-top: 20px;
            padding: 15px;
            background: #f0f8ff;
            border: 1px solid #b0d4ff;
            border-radius: 5px;
            min-height: 100px;
        }
        .success {
            background: #e8f5e9;
            border-color: #4caf50;
        }
        .error {
            background: #ffebee;
            border-color: #f44336;
        }
        .info {
            background: #fff3e0;
            border-color: #ff9800;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .model-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 10px;
        }
        .model-available {
            background: #4caf50;
            color: white;
        }
        .model-limited {
            background: #ff9800;
            color: white;
        }
        .model-unavailable {
            background: #f44336;
            color: white;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
            flex: 1;
            margin: 0 5px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007AFF;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 真实API集成测试</h1>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="totalRequests">0</div>
                <div class="stat-label">总请求数</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="successCount">0</div>
                <div class="stat-label">成功数</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="avgTime">0ms</div>
                <div class="stat-label">平均响应时间</div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>📝 测试配置</h2>
            
            <div class="input-group">
                <label for="testText">测试文本：</label>
                <textarea id="testText" rows="4">投资有风险，请谨慎决策。在进行任何投资前，请充分了解相关产品的特性和风险。</textarea>
            </div>
            
            <div class="input-group">
                <label for="siteType">场景类型：</label>
                <select id="siteType">
                    <option value="general">通用</option>
                    <option value="longport">LongPort金融</option>
                    <option value="notion">Notion文档</option>
                </select>
            </div>
            
            <div class="input-group">
                <label for="modelSelect">选择模型：</label>
                <select id="modelSelect">
                    <option value="auto">自动选择</option>
                    <option value="gpt-4o-mini">GPT-4o Mini (推荐)</option>
                    <option value="gpt-4o">GPT-4o</option>
                    <option value="gpt-5-chat">GPT-5 Chat</option>
                    <option value="DeepSeek-R1">DeepSeek-R1</option>
                    <option value="o3-mini">O3 Mini</option>
                    <option value="o3">O3</option>
                </select>
            </div>
            
            <button id="testRealAPI" onclick="testRealAPI()">测试真实API</button>
            <button id="testMockAPI" onclick="testMockAPI()">测试模拟API</button>
            <button id="compareAPIs" onclick="compareAPIs()">对比测试</button>
            <button id="testAllModels" onclick="testAllModels()">测试所有模型</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        // 统计数据
        let stats = {
            totalRequests: 0,
            successCount: 0,
            totalTime: 0
        };
        
        function updateStats() {
            document.getElementById('totalRequests').textContent = stats.totalRequests;
            document.getElementById('successCount').textContent = stats.successCount;
            const avgTime = stats.totalRequests > 0 ? Math.round(stats.totalTime / stats.totalRequests) : 0;
            document.getElementById('avgTime').textContent = avgTime + 'ms';
        }
        
        function addResult(title, content, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const resultBox = document.createElement('div');
            resultBox.className = `result-box ${type}`;
            
            const titleEl = document.createElement('h3');
            titleEl.textContent = title;
            resultBox.appendChild(titleEl);
            
            const contentEl = document.createElement('pre');
            contentEl.textContent = content;
            resultBox.appendChild(contentEl);
            
            resultsDiv.insertBefore(resultBox, resultsDiv.firstChild);
        }
        
        function showLoading(message) {
            const resultsDiv = document.getElementById('results');
            const loadingBox = document.createElement('div');
            loadingBox.className = 'result-box info';
            loadingBox.id = 'loadingBox';
            loadingBox.innerHTML = `${message}<span class="loading"></span>`;
            resultsDiv.insertBefore(loadingBox, resultsDiv.firstChild);
        }
        
        function hideLoading() {
            const loadingBox = document.getElementById('loadingBox');
            if (loadingBox) {
                loadingBox.remove();
            }
        }
        
        async function callAPI(text, siteType, useRealAPI = true) {
            const startTime = Date.now();
            stats.totalRequests++;
            
            try {
                const result = await chrome.runtime.sendMessage({
                    action: 'callAI',
                    text: text,
                    apiType: useRealAPI ? 'company' : 'mock',
                    siteType: siteType
                });
                
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                stats.totalTime += responseTime;
                
                if (result && typeof result === 'string' && result.trim().length > 0) {
                    stats.successCount++;
                    updateStats();
                    return {
                        success: true,
                        result: result,
                        responseTime: responseTime
                    };
                } else {
                    updateStats();
                    return {
                        success: false,
                        error: '返回结果为空或无效',
                        responseTime: responseTime
                    };
                }
            } catch (error) {
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                stats.totalTime += responseTime;
                updateStats();
                
                return {
                    success: false,
                    error: error.message,
                    responseTime: responseTime
                };
            }
        }
        
        async function testRealAPI() {
            const text = document.getElementById('testText').value;
            const siteType = document.getElementById('siteType').value;
            
            showLoading('正在调用真实API...');
            disableButtons(true);
            
            const result = await callAPI(text, siteType, true);
            
            hideLoading();
            disableButtons(false);
            
            if (result.success) {
                addResult(
                    `✅ 真实API调用成功 (${result.responseTime}ms)`,
                    `原文：${text}\n\n优化后：${result.result}`,
                    'success'
                );
            } else {
                addResult(
                    `❌ 真实API调用失败 (${result.responseTime}ms)`,
                    `错误：${result.error}`,
                    'error'
                );
            }
        }
        
        async function testMockAPI() {
            const text = document.getElementById('testText').value;
            const siteType = document.getElementById('siteType').value;
            
            showLoading('正在调用模拟API...');
            disableButtons(true);
            
            const result = await callAPI(text, siteType, false);
            
            hideLoading();
            disableButtons(false);
            
            if (result.success) {
                addResult(
                    `✅ 模拟API调用成功 (${result.responseTime}ms)`,
                    `原文：${text}\n\n优化后：${result.result}`,
                    'success'
                );
            } else {
                addResult(
                    `❌ 模拟API调用失败 (${result.responseTime}ms)`,
                    `错误：${result.error}`,
                    'error'
                );
            }
        }
        
        async function compareAPIs() {
            const text = document.getElementById('testText').value;
            const siteType = document.getElementById('siteType').value;
            
            showLoading('正在进行对比测试...');
            disableButtons(true);
            
            // 同时测试两个API
            const [realResult, mockResult] = await Promise.all([
                callAPI(text, siteType, true),
                callAPI(text, siteType, false)
            ]);
            
            hideLoading();
            disableButtons(false);
            
            let comparison = `原文：${text}\n\n`;
            comparison += '='.repeat(50) + '\n\n';
            
            comparison += `真实API (${realResult.responseTime}ms):\n`;
            if (realResult.success) {
                comparison += `✅ 成功\n${realResult.result}\n\n`;
            } else {
                comparison += `❌ 失败: ${realResult.error}\n\n`;
            }
            
            comparison += '='.repeat(50) + '\n\n';
            
            comparison += `模拟API (${mockResult.responseTime}ms):\n`;
            if (mockResult.success) {
                comparison += `✅ 成功\n${mockResult.result}`;
            } else {
                comparison += `❌ 失败: ${mockResult.error}`;
            }
            
            const type = realResult.success && mockResult.success ? 'success' : 
                        realResult.success || mockResult.success ? 'info' : 'error';
            
            addResult('📊 API对比测试结果', comparison, type);
        }
        
        async function testAllModels() {
            const text = document.getElementById('testText').value;
            const models = ['gpt-4o-mini', 'gpt-4o', 'gpt-5-chat', 'DeepSeek-R1', 'o3-mini', 'o3'];
            
            showLoading('正在测试所有模型...');
            disableButtons(true);
            
            let results = '模型测试结果:\n\n';
            
            for (const model of models) {
                // 这里需要扩展background.js以支持指定模型
                results += `${model}: 测试功能开发中...\n`;
            }
            
            hideLoading();
            disableButtons(false);
            
            addResult('🧪 所有模型测试', results, 'info');
        }
        
        function disableButtons(disabled) {
            document.getElementById('testRealAPI').disabled = disabled;
            document.getElementById('testMockAPI').disabled = disabled;
            document.getElementById('compareAPIs').disabled = disabled;
            document.getElementById('testAllModels').disabled = disabled;
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            addResult('💡 测试说明', 
                '1. 真实API已配置可用模型：gpt-4o-mini, gpt-4o, gpt-5-chat等\n' +
                '2. 如遇到429错误（速率限制），系统会自动切换到下一个可用模型\n' +
                '3. 模拟API提供基础优化功能，确保服务始终可用\n' +
                '4. 使用对比测试可以查看两种API的效果差异',
                'info'
            );
        });
    </script>
</body>
</html>
