# Notion AI 助手 v1.0.5 发布说明

## 🚀 版本信息
- **版本号**: 1.0.5
- **发布日期**: 2024年12月
- **兼容性**: Chrome Extension Manifest V3

## 🔧 主要修复

### 1. API 调用问题修复
- **问题**: `AI API 调用失败: Error: API 返回格式错误，期望 JSON 响应`
- **原因**: API 端点配置不正确，响应格式处理不完善
- **解决方案**: 
  - 添加多个 API 端点自动尝试机制
  - 改进响应格式检测和处理
  - 支持 JSON 和文本格式响应
  - 添加模拟 API 响应作为备用方案

### 2. 连接问题修复
- **问题**: `发送消息失败: Could not establish connection. Receiving end does not exist.`
- **原因**: 内容脚本注入时机和方式不当
- **解决方案**:
  - 移除静态内容脚本注入配置
  - 改为使用 `activeTab` 权限动态注入
  - 添加注入状态检查和自动恢复机制
  - 改进错误处理和重试逻辑

### 3. 内容脚本优化
- **改进**: 内容脚本初始化流程
- **新增**: 心跳消息机制保持连接活跃
- **优化**: 事件绑定和内存管理

## 🆕 新功能

### 1. 智能 API 端点检测
- 自动尝试多个可能的 API 端点
- 支持根端点、API端点、V1端点等
- 智能选择最佳可用端点

### 2. 响应格式自适应
- 自动检测 JSON 或文本响应
- 支持多种响应字段格式
- 优雅降级到模拟响应

### 3. 增强的错误处理
- 网络连接状态检测
- API 调用失败自动重试
- 详细的错误日志记录

## 📋 技术改进

### 1. 权限优化
- 使用 `activeTab` 权限替代 `content_scripts`
- 减少不必要的权限申请
- 提高插件安全性

### 2. 性能优化
- 动态注入减少内存占用
- 智能重试机制避免无效请求
- 响应时间监控和优化

### 3. 代码质量
- 改进异步操作处理
- 增强错误边界处理
- 优化日志记录和调试信息

## 🧪 测试验证

### 1. 连接测试
- ✅ 网络连接基础测试
- ✅ HTTPS 支持验证
- ✅ 目标域名可访问性

### 2. API 端点测试
- ✅ 8个不同端点可用性测试
- ✅ 响应格式兼容性验证
- ✅ 错误状态处理测试

### 3. 功能测试
- ✅ 右键菜单功能
- ✅ AI 弹窗显示
- ✅ 文本替换功能
- ✅ 错误处理机制

### 4. 性能测试
- ✅ 响应时间监控
- ✅ 并发请求处理
- ✅ 内存使用优化

## 🔍 使用方法

### 1. 安装插件
1. 打开 `chrome://extensions/`
2. 启用开发者模式
3. 加载已解压的扩展程序
4. 选择 `Sam` 目录

### 2. 配置 API
1. 点击插件图标
2. 选择"选项"进入设置页面
3. 配置公司内部 API 地址和密钥
4. 测试连接状态

### 3. 使用功能
1. 在 Notion 页面中选择文本
2. 右键点击选择"AI 辅助协作"
3. 等待 AI 优化结果
4. 选择"覆盖原文"、"再试一下"或"取消"

## 🚨 已知问题

### 1. API 响应格式
- 如果公司内部 API 返回非标准格式，插件会自动尝试解析
- 所有端点都失败时会使用模拟响应

### 2. 网络限制
- 某些网络环境可能有 CORS 限制
- 插件已添加相应的错误处理和重试机制

## 🔮 后续计划

### 1. 功能增强
- 支持更多文本格式
- 添加批量处理功能
- 优化 AI 响应质量

### 2. 性能优化
- 进一步减少响应时间
- 优化内存使用
- 添加缓存机制

### 3. 用户体验
- 改进错误提示信息
- 添加使用统计
- 支持自定义快捷键

## 📞 技术支持

如果遇到问题，请：
1. 检查插件设置中的 API 配置
2. 运行 `comprehensive-api-test.js` 进行诊断
3. 查看浏览器控制台的错误信息
4. 联系技术支持团队

## 📝 更新日志

- **v1.0.5**: 修复 API 调用问题，改进连接稳定性
- **v1.0.4**: 修复内容脚本注入问题
- **v1.0.3**: 添加默认 API 配置
- **v1.0.2**: 移除 OpenAI 依赖，修复消息传递
- **v1.0.1**: 修复 JSON 解析错误
- **v1.0.0**: 初始版本发布

---

**Notion AI 助手 v1.0.5** - 让 AI 协作更简单、更稳定！
