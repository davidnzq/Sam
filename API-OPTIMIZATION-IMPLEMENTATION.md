# API优化实施方案

## 问题分析

根据用户反馈，线上存在以下问题：
1. 设置中测试API连接显示响应格式错误：服务器响应成功(200)，但返回的不是有效的JSON数据
2. 在文案优化效果测试中，输入文字基本返回原文
3. 调用的API显示请求次数没有变化

## 已实施的优化方案

### 1. 多种请求格式支持

为了提高与不同API服务的兼容性，我们实现了多种请求格式的自动尝试：

```typescript
const requestFormats = [
  { text }, // 最简化格式
  { text, mode: isStrictMode ? 'strict' : 'basic' }, // 添加模式字段
  { content: text }, // 使用content字段
  { input: text }, // 使用input字段
  { message: text }, // 使用message字段
  { 
    text, 
    isStrictMode,
    optimizationDimensions: {
      grammarCorrection: true,
      punctuationNormalization: true,
      mixedTextFormatting: true,
      styleRefinement: true,
      toneControl: true
    }
  } // 完整格式
];
```

### 2. 智能响应解析

系统会自动尝试解析不同格式的响应，支持多种字段名：

```typescript
const hasOptimizedText = data && (
  data.optimizedText || 
  data.text || 
  data.content || 
  data.output || 
  data.result ||
  data.message
);
```

### 3. 渐进式错误处理

- 如果某个请求格式失败，自动尝试下一个格式
- 详细的日志记录，便于调试
- 支持HTML响应的检测和跳过

## 测试和验证步骤

### 步骤1：重新加载扩展

1. 在Chrome中访问 `chrome://extensions/`
2. 找到"LongPort AI Pro"扩展
3. 点击刷新按钮重新加载扩展

### 步骤2：配置API设置

1. 点击扩展图标，进入设置页面
2. 确保API地址和API密钥正确配置
3. 点击"保存设置"

### 步骤3：测试API连接

1. 在设置页面点击"测试API连接"按钮
2. 观察测试结果和详细日志
3. 如果仍然失败，查看浏览器控制台的详细错误信息

### 步骤4：测试文案优化

1. 点击"文案优化测试"按钮
2. 输入测试文本（建议使用有明显语法问题的文本）
3. 选择优化模式
4. 点击"执行优化"按钮
5. 观察优化结果和网络请求

### 步骤5：检查网络请求

1. 打开Chrome开发者工具（F12）
2. 切换到"网络"(Network)标签
3. 执行文案优化操作
4. 查找对API端点的POST请求
5. 检查请求载荷和响应内容

## 调试信息

### 控制台日志

系统会在控制台输出详细的调试信息：

```
[测试页面] 将尝试 6 种请求格式
[测试页面] 尝试请求格式 1: {text: "测试文本"}
[测试页面] 格式 1 响应内容类型: application/json
[测试页面] 格式 1 响应原始内容: {"result": "优化后的文本"}
[测试页面] 格式 1 解析成功: {result: "优化后的文本"}
[测试页面] 格式 1 成功获取优化文本，停止尝试
[测试页面] 使用格式 1 成功调用API
```

### 网络请求详情

每个请求格式都会产生一个网络请求，可以在网络面板中查看：
- 请求方法：POST
- 请求头：包含Content-Type、Authorization等
- 请求体：不同格式的JSON数据
- 响应状态：HTTP状态码
- 响应内容：API返回的数据

## 故障排除

### 常见问题及解决方案

#### 1. 所有请求格式都失败

**症状**：控制台显示"所有请求格式都失败了，请检查API配置和网络连接"

**解决方案**：
- 检查API端点是否正确
- 验证API密钥是否有效
- 确认API服务是否正常运行
- 检查网络连接和防火墙设置

#### 2. API返回HTML内容

**症状**：控制台显示"返回了HTML内容，跳过"

**解决方案**：
- 检查API端点是否指向了登录页面或错误页面
- 确认API密钥权限是否足够
- 验证API服务是否需要额外的认证步骤

#### 3. 响应解析失败

**症状**：控制台显示"解析JSON失败"

**解决方案**：
- 检查API响应格式是否符合预期
- 确认API服务是否返回有效的JSON数据
- 查看响应内容，了解实际返回的数据格式

## 验收标准

### 1. 设置中测试API连接通过
- 点击"测试API连接"按钮后显示"连接成功"
- 控制台显示成功使用某种请求格式

### 2. 文案优化测试返回优化文字
- 输入测试文本后，返回的文本与输入文本不同
- 优化后的文本符合产品文档中的要求
- 控制台显示成功调用API的日志

### 3. API服务记录到请求
- 在API提供方的控制台或日志中能看到请求记录增加
- 网络面板中显示成功的API请求
- 响应状态码为200，响应内容为有效的JSON数据

## 下一步计划

1. **监控API调用成功率**：收集数据，分析不同请求格式的成功率
2. **优化请求格式**：根据实际使用情况，调整请求格式的优先级
3. **增强错误处理**：为特定错误类型提供更具体的解决建议
4. **性能优化**：分析API调用性能，寻找优化空间

## 技术支持

如果在测试过程中遇到问题，请：

1. 查看浏览器控制台的详细日志
2. 检查网络面板中的请求和响应
3. 确认API配置是否正确
4. 联系API服务提供商确认服务状态

通过以上优化方案，我们期望能够解决线上API调用问题，确保文案优化功能正常工作。
